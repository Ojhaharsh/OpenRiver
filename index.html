<!DOCTYPE html>
<html>
<head>
    <title>River Solver | Interactive</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1e1e1e; color: #e0e0e0; padding: 20px; }
        h1 { font-weight: 300; border-bottom: 1px solid #444; padding-bottom: 10px; margin-top: 0; }
        
        /* Input Area Styles */
        .controls { background: #333; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; gap: 10px; align-items: center; }
        input[type="text"] {
            padding: 10px; border-radius: 4px; border: 1px solid #555; background: #222; color: white; font-size: 16px; width: 200px; text-transform: capitalize;
        }
        button {
            padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; transition: background 0.2s;
        }
        button:hover { background: #1976d2; }
        button:disabled { background: #555; cursor: not-allowed; }
        .status { margin-left: auto; color: #888; font-size: 14px; }

        /* Grid Styles */
        .node-group { margin-bottom: 40px; }
        .node-title { font-size: 1.2em; color: #aaa; margin-bottom: 10px; border-left: 4px solid #444; padding-left: 10px; }
        .grid { display: grid; grid-template-columns: repeat(13, 1fr); gap: 4px; }
        .card-cell { 
            background: #252525; border-radius: 4px; overflow: hidden; 
            text-align: center; font-size: 11px; position: relative;
            height: 45px; display: flex; flex-direction: column;
            border: 1px solid #333;
        }
        .card-label { 
            z-index: 2; position: absolute; width: 100%; top: 0; 
            background: rgba(0,0,0,0.6); font-weight: bold; padding: 1px 0; pointer-events: none;
        }
        .strategy-bar { display: flex; height: 100%; width: 100%; }
        .segment { height: 100%; }
        .act-c { background: #4caf50; } 
        .act-b { background: #f44336; } 
        .act-f { background: #2196f3; }
        
        /* Legend */
        .legend { display: flex; gap: 20px; margin-bottom: 20px; font-size: 0.9em; background: #2a2a2a; padding: 10px; border-radius: 4px; }
        .dot { width: 12px; height: 12px; display: inline-block; border-radius: 2px; margin-right: 6px; position: relative; top: 1px; }
    </style>
</head>
<body>
    <h1>River Strategy Matrix</h1>

    <div class="controls">
        <label>Board Cards:</label>
        <input type="text" id="boardInput" value="Ks Th 7s 4d 2s" placeholder="e.g. As Kd...">
        <button onclick="runSolver()" id="solveBtn">Solve Board</button>
        <div class="status" id="statusText">Ready</div>
    </div>

    <div class="legend">
        <div><span class="dot act-c"></span>Check / Call</div>
        <div><span class="dot act-b"></span>Bet</div>
        <div><span class="dot act-f"></span>Fold</div>
    </div>

    <div id="app"></div>

    <script>
        const RANK_ORDER = ['A', 'K', 'Q', 'J', 'T', '9', '8', '7', '6', '5', '4', '3', '2'];
        
        async function runSolver() {
            const btn = document.getElementById('solveBtn');
            const status = document.getElementById('statusText');
            const board = document.getElementById('boardInput').value;

            // UI Loading State
            btn.disabled = true;
            status.innerText = "Calculated Hand Strengths... Training Solver...";
            document.getElementById('app').style.opacity = "0.5";

            try {
                // 1. Tell Backend to Retrain (this might take 3-5 seconds)
                // We send the board as a query parameter
                const trainRes = await fetch(`http://localhost:8000/train?iters=100000&board=${encodeURIComponent(board)}`);
                if (!trainRes.ok) throw new Error("Training failed");

                status.innerText = "Downloading Strategy...";

                // 2. Fetch the new Result
                const solRes = await fetch('http://localhost:8000/solution');
                const data = await solRes.json();
                
                render(data);
                status.innerText = `Solved: ${board}`;
            } catch (e) {
                status.innerText = "Error: Is main.py running?";
                console.error(e);
            } finally {
                btn.disabled = false;
                document.getElementById('app').style.opacity = "1";
            }
        }

        function render(data) {
            const container = document.getElementById('app');
            container.innerHTML = '';
            
            // Define nodes and readable titles
            const nodeMap = [
                { id: "", title: "Root (Player 1 Decision)" },
                { id: "b", title: "Facing Bet (Player 2)" },
                { id: "c", title: "Checked To (Player 2)" },
                { id: "cb", title: "P1 Check-Raise Decision" }
            ];

            nodeMap.forEach(nodeInfo => {
                if (!data[nodeInfo.id]) return;
                
                const section = document.createElement('div');
                section.className = 'node-group';
                section.innerHTML = `<div class="node-title">${nodeInfo.title}</div>`;
                
                const grid = document.createElement('div');
                grid.className = 'grid';
                
                // Sort hands A->2
                const cards = Object.keys(data[nodeInfo.id].hands).sort((a,b) => {
                    return RANK_ORDER.indexOf(a[0]) - RANK_ORDER.indexOf(b[0]);
                });

                cards.forEach(card => {
                    const strat = data[nodeInfo.id].hands[card];
                    const actions = data[nodeInfo.id].actions;
                    
                    const cell = document.createElement('div');
                    cell.className = 'card-cell';
                    
                    let bars = `<div class="strategy-bar">`;
                    actions.forEach((act, idx) => {
                        const pct = strat[idx] * 100;
                        if (pct > 0.5) { // Optimization: Only render bars > 0.5% width
                            bars += `<div class="segment act-${act}" style="width:${pct}%" title="${act.toUpperCase()}: ${pct.toFixed(1)}%"></div>`;
                        }
                    });
                    bars += `</div>`;
                    
                    cell.innerHTML = `${bars}<div class="card-label">${card}</div>`;
                    grid.appendChild(cell);
                });
                
                section.appendChild(grid);
                container.appendChild(section);
            });
        }

        // Run once on load to show default
        runSolver();
    </script>
</body>
</html>